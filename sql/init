-- Tabla principal de salas
CREATE TABLE IF NOT EXISTS projector_rooms (
  id VARCHAR(50) PRIMARY KEY DEFAULT gen_random_uuid()::text,
  room_name VARCHAR(100) NOT NULL,
  host_username VARCHAR(100) NOT NULL,
  manifest JSONB NOT NULL,
  source_url TEXT NOT NULL,
  use_host_source BOOLEAN DEFAULT true,
  projector_type VARCHAR(20) DEFAULT 'public',
  custom_manifest TEXT,
  created_at TIMESTAMP DEFAULT NOW()
);

-- Tabla de mensajes (persistencia chat)
CREATE TABLE IF NOT EXISTS room_messages (
  id SERIAL PRIMARY KEY,
  room_id VARCHAR(50) NOT NULL,
  username VARCHAR(100) NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (room_id) REFERENCES projector_rooms(id) ON DELETE CASCADE
);

-- Tabla de calificaciones
CREATE TABLE IF NOT EXISTS room_ratings (
  id SERIAL PRIMARY KEY,
  room_id VARCHAR(50) NOT NULL,
  username VARCHAR(100) NOT NULL,
  rating INTEGER NOT NULL CHECK (rating >= 1 AND rating <= 10),
  created_at TIMESTAMP DEFAULT NOW(),
  UNIQUE(room_id, username),
  FOREIGN KEY (room_id) REFERENCES projector_rooms(id) ON DELETE CASCADE
);

-- Tabla de reacciones
CREATE TABLE IF NOT EXISTS room_reactions (
  id SERIAL PRIMARY KEY,
  room_id VARCHAR(50) NOT NULL,
  username VARCHAR(100) NOT NULL,
  time VARCHAR(10) NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP DEFAULT NOW(),
  FOREIGN KEY (room_id) REFERENCES projector_rooms(id) ON DELETE CASCADE
);

-- Ãndices para performance
CREATE INDEX IF NOT EXISTS idx_room_messages_room_id ON room_messages(room_id);
CREATE INDEX IF NOT EXISTS idx_room_messages_created_at ON room_messages(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_room_ratings_room_id ON room_ratings(room_id);
CREATE INDEX IF NOT EXISTS idx_room_reactions_room_id ON room_reactions(room_id);
CREATE INDEX IF NOT EXISTS idx_projector_rooms_created_at ON projector_rooms(created_at DESC);
